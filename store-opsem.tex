\section{Operational Semantics}
\label{sec:store-opsem}

\renewcommand{\auxred}[4]{#1 \vdash #2 \;\xhookrightarrow{#3}\; #4 }

We now describe operational semantics of a data store that implements
strong, causal and eventual consistency guarantees. The semantics also
serves as a high-level description of our implementation of the store
underlying \name.

Figure ~\ref{sem:oper} presents operational semantics as rules
defining the reduction relation ($\xrightarrow{}$) over the execution
state.  Since we now have a concrete store, we extend our system model
with $\Theta$, a representation of the store as a map from replicas to
their local states. The local state of a replica $r$ (i.e.,
$\Theta(r)$) is a set of effects that are currently visible at $r$.
An operation $op$ performed at replica $r$ can only witness the set of
effects ($\Theta(r)$) visible at $r$. To avoid too many paranthesis in
our formal presentation, we represent operation $op$, whose contract
is in consistency class $\tau$, as $op_\tau$ instead of the usual
$\langle op,\tau \rangle$. For the sake of clarity, we only
consider a single replicated object of well-defined type (for eg: a
replicated object of type \cf{BankAccount}) in our formalization.  Our
semantics are parametric over the specification of this replicated
data type. Figure~\ref{sem:oper} formalizes replicated data type (RDT)
specification as tuple $(\delta,\Ops,\Ctrts)$, where $\delta$ is the
data type, $\Ops$ maps labels ($op$) of operations on $\delta$ to
their definitions, while $\Ctrts$ maps them to their consistency
contracts ($\cv$). The definition of an operation is expected to be a
lambda expression, although we do not enforce this in our
formalization. For technical reasons, we tag each session with a
session identifier ($s$) and the sequence number ($i$) of the next
operation in the session.

The state of an operational execution ($\E$) is a tuple $\Exec$ where
$\EffSoup$ is a set of effects, and $\visZ$, $\soZ$, $\sameobjZ$
$\subseteq$ $\EffSoup \times \EffSoup$ are \emph{visibility},
\emph{session order}, and \emph{same object} relations over effects,
respectively. We define an effect ($\eff$) as a tuple
$(s,i,op,v)$, which records the fact that $i^{th}$ action in session
with {\sf SessID} $s$, which is an operation $op$ on the replicated
object, has been successfully executed on some replica yielding a
return value $v$. Note that the combination of $s$ and $i$ uniquely
identifies the effect. Session order relation ($\soZ$) relates effects
generated by the same session.  An effect $\eff = (s,i,op,v)$ is said
to precede another effect $\eff' = (s',i',op',v')$ in session order if
and only if $s'=s$ and $i'\ge i$. Since we only consider one
replicated object in our formalization, the $\sameobjZ$ relation
relates every pair of effects in the effect soup ($\EffSoup$). An
effect generated at a replica becomes visible at rest of the replicas
eventually.  If we denote the effect generated by the operation $op$
as $\eff_{op}$, then $\Theta(r) \times \{\eff_{op}\} ~\subseteq~
\visZ$. Often, in our formalization, we use $\visZ$ and $\soZ$ binary
relations to obtain a set of effects visible to a given effect $\eff$,
or set of effects that precede a given effect $\eff$ in the session
order. As a syntactic convenience, whenever $R$ is a binary relation,
we write $R(\eff)$ to denote the set of all $\eff'$ such that
$(\eff,\eff') \in R$.  Conversely, we write $R^{-1}(\eff)$ to denote
the set of all $\eff'$ such that $(\eff',\eff) \in R$.

Basic gurantee provided by the store is causal visibility, which is
captured by the rule $\rulelabel{EffVis}$ as a condition for an effect
to be visible at a replica. The rule makes an effect ($\eff$) visible
at a replica $r$ only after all the effects that causally precede
$\eff$ are made visible at $r$.  It is important to note that that
enforcing causal visibility does not require any inter-replica
coordination. Any eventually consistent store can provide causal
visibility while being eventually consistent.  Therefore, we do not
lose any generality by assuming that the store provides causal
visiblity.

% Semantics
% ---------
\input{store-opsem-rules}

Rule $\rulelabel{Oper}$ is an auxiliary reduction of the
form:\vspace{-1.7mm}
\begin{smathpar}
\auxred{\Theta} {(\E,\langle s,i,op \rangle)} {r} {(\E',\eff)}
\vspace{-1.7mm}
\end{smathpar}
\noindent Under the store configuration $\Theta$, the rule captures
the progress in execution (from $\E$ to $\E'$) due to the application
of operation $op$ to replica $r$ resulting in a new effect $\eff$.
The rule first constructs a \emph{context} for the application from
the local state ($\Theta(r)$) of the replica, by
projecting\footnote{{\textsf{ctxt*}} is auxiliary function
\textsf{ctxt} extended straightforwardly to set of effects} relevant
information from effects in $\Theta(r)$. It then substitutes the
definition ($\Ops(op)$) of the operation for its label ($op$), and
relies on the reduction relation ($\rdtredsto$) of the server-side
language to reduce the application $\Ops(op)(ctxt)$ to a value $v'$.
Subsequently, the the attributes of execution state, namely
$\EffSoup$, $\visZ$, $\soZ$, and $\sameobjZ$ are extended to
incorporate the new effect ($\eff$).

If the operation $op$ is {\sf EventuallyConsistent}, we simply apply
the operation to any replica $r$. Since the store provides causal
visibility, eventually consistent operations are satisfiable under any
replica. If the operation is {\sf CausallyConsistent}, the operation
can be applied to a replica $r$ only if it already contains the
effects of all the previous operations from the same session. This
guarantee can be satisfied by applying all operations from the same
session to the same logical copy of the database.  If such a logical
copy is untenable, then the operation might block. Since the store is
assumed to converge eventually, the blocked causally consistent
operation guaranteed to unblock eventually.

A {\sf StronglyConsistent} operation expects sequential consistency.
That is, universe of all effects ($\EffSoup$) in an execution ($\E$)
must be partitionable into a set of effects that \emph{happened
before} $\eff$ and another set that \emph{happened after} $\eff$,
where $\eff$ is the effect generated by an strongly consistent
operation. The rule $\rulelabel{SC}$ enforces this sequencing in two
steps; firstly, it insists that the the strongly consistent operation
($op$) witness effects of all operations executed so far by requiring
the global set of effects $\EffSoup$ to be a subset of local state
($\Theta(r)$) of the replica ($r$) executing $op$. Secondly, the rule
requires the effect ($\eff$) generated by $op$ to be added to the
local state of every other replica in the store, so that further
operations on these replicas can witness the effect of $op$. Since
both these steps require global coordination among replicas, the store
is \emph{unavailable} during the time it is executing $op$.
% However, it must be noted that executing strongly consistent
% operation does not entail the convergence of local states of all
% replicas; it simply means that there is one replica ($r$) whose
% local state is the upper bound of local states of all replicas, and
% there exists a set containing atleast one effect ($\eff$), which is
% their lower bound.

\subsection{Soundness of Operational Semantics}

We now prove a meta-theoretic property that establishes the soundness
of our operational semantics in enforcing $\ecc$, $\ccc$, and $\scc$
consistency guarantees at every reduction step. As a corollary of this
result, and Theorem~\ref{thm:classification-sound}, we have the
assurance that \name correctly enforces all well-formed consistency
contracts.

First, we prove a useful lemma:

\begin{lemma}[Auxiliary Reduction Preserves Well-Formedness]
For every well-formed execution state $\E$, if
$\auxred{\Theta}{(\E,\langle s,i,op \rangle)} {r} {(\E',\eff)}$, then
$\E'$ is well-formed.
\end{lemma}
\begin{proof}
  Let us denote $\E.\EffSoup$, $\E.\Rvis$, $\E.\Rso$, and $\E.\sameobjZ$
  as $\EffSoup$, $\Rvis$, $\Rso$, and $\sameobjZ$ respectively.
  Likewise, let us denote $\E'.\EffSoup$, $\E'.\Rvis$, $\E'.\Rso$, and
  $\E'.\sameobjZ$ as $\EffSoup$, $\Rvis$, $\Rso$, and $\sameobjZ$
  respectively. By inversion on $\auxred{\Theta}{(\E,\langle s,i,op
  \rangle)} {r} {(\E',\eff)}$, we have following hypotheses:
  \begin{smathpar}
  \begin{array}{cr}
    r \in \dom(\Theta) & H\npp\\
    ctxt = {\ctxtFn}^{*}(\Theta(r)) & H\npp\\
    \Ops(op)(ctxt) {\rdtredsto}^{*} v & H\npp\\
    \eff = (s,i,op,v) & H\npp\\
    \{\eff'\} = \EffSoup_{({\sf SessID}=s,\,{\sf SeqNo}=i-1)}\\
    \EffSoup' = \{\eff\} \cup \EffSoup & H\npp\\
    \visZ' = \Theta(r)\times\{\eff\} \cup \visZ & H\npp\\
    \soZ' = (\soZ^{-1}(\eff') \cup \eff') \times\{\eff\} \cup \soZ
      & H\npp \\
    \sameobjZ' = \EffSoup' \times \EffSoup' & H\npp\\
  \end{array}
  \end{smathpar}
  Since $\E$ is well-formed, from the definition of
  well-formedness and \emph{models} relation, we have the following:
  \begin{smathpar}
  \begin{array}{cr}
    \forall (a \in \EffSoup). \neg\hboZ(a,a) & H\npp\\
    \forall (a,b \in \EffSoup). \visZ(a,b) \Rightarrow 
      \sameobjZ(a,b) & H\npp\\
    \forall (a,b,c \in \EffSoup). \soZ(a,b) \conj \soZ(b,c) \Rightarrow
      \soZ(a,c) & H\npp\\
    \forall (a \in \EffSoup). \sameobjZ(a,a) & H\npp\\
    \forall (a,b \in \EffSoup). \sameobjZ(a,b) \Rightarrow 
      \sameobjZ(b,a) & H\npp\\
    \forall (a,b,c \in \EffSoup). \soZ(a,b) \conj \soZ(b,c) \Rightarrow
      \soZ(a,c) & H\npp\\
  \end{array}
  \end{smathpar}
  Since $\hboZ = (\Rvis \cup \Rso)^{+}$, $H8$ is equivalent to
  conjunction of following assertions:
  \begin{smathpar}
  \begin{array}{cr}
    \forall (a \in \EffSoup). \neg\visZ(a,a) & H\npp\\
    \forall (a \in \EffSoup). \neg\soZ(a,a) & H\npp\\
    \forall (a,b \in \EffSoup). \neg (\visZ(a,b) \conj \soZ(b,a)) & H\npp\\
  \end{array}
  \end{smathpar}
  Since $\eff$ is fresh, $\eff \notin \Theta(r)$. From $H4$, $H5$, and
  $H14$, we have the acyclicity property for $\visZ'$:
  \begin{smathpar}
  \begin{array}{cr}
    \forall (a \in \EffSoup'). \neg\visZ'(a,a) & H\npp\\
  \end{array}
  \end{smathpar}
  Also, $\eff \notin \EffSoup$, and from $H4$, $H6$ and $H15$, we have
  acyclicity for $\soZ'$: 
  \begin{smathpar}
  \begin{array}{cr}
    \forall (a \in \EffSoup'). \neg\soZ'(a,a) & H\npp\\
  \end{array}
  \end{smathpar}
  Similarly, from the uniqueness of $\eff$, and $H5$, $H6$, and $H16$,
  we have the following:
  \begin{smathpar}
  \begin{array}{cr}
    \forall (a,b \in \EffSoup'). \neg (\visZ'(a,b) \conj \soZ'(b,a)) & H\npp\\
  \end{array}
  \end{smathpar}
  From $H17-19$, we prove the acyclicity of $\hboZ'$: 
  \begin{smathpar}
  \begin{array}{cr}
    \forall (a \in \EffSoup').\neg\hboZ(a,a) & G\mpp\\
  \end{array}
  \end{smathpar}
  The $\sameobjZ'$ relation is simply the cross product
  $\EffSoup' \times \EffSoup'$. Hence following trivially hold:
  \begin{smathpar}
  \begin{array}{cr}
    \forall (a,b \in \EffSoup'). \visZ'(a,b) \Rightarrow 
      \sameobjZ'(a,b) & G\mpp\\
    \forall (a \in \EffSoup'). \sameobjZ'(a,a) & G\mpp\\
    \forall (a,b \in \EffSoup'). \sameobjZ'(a,b) \Rightarrow 
      \sameobjZ'(b,a) & G\mpp\\
  \end{array}
  \end{smathpar}
  Finally, from $H4$, $H6$ and $H10$, we have transitivity for $\soZ'$:
  \begin{smathpar}
  \begin{array}{cr}
    \forall (a,b,c \in \EffSoup'). \soZ'(a,b) \conj \soZ'(b,c) \Rightarrow
      \soZ'(a,c) & G\mpp\\
  \end{array}
  \end{smathpar}
  Well-formedness of $\E'$ follows from $G0-4$.
\end{proof}

We now define causal consistency property of the store formally:

\begin{definition}
  A store $\Theta$ is said to be causally consistent under an execution
  $\E=\Exec$ if and only if:
  \begin{smathpar}
  \begin{array}{cr}
    \hspace*{-0.5in}\forall (r\in{\sf dom}(\Theta)). \forall (\eff \in
      \Theta(r)). & \\
    \hspace*{0.3in}\forall (a\in \EffSoup). \hbo{a}{\eff} \Rightarrow a 
      \in \Theta(r) & H\npp \\
  \end{array}
  \end{smathpar}
  Where, $\hboZ = (\Rvis \cup \Rso)^{+}$
\end{definition}

\begin{theorem}[Soundness Modulo Classification]
\label{thm:weak-soundness}
For every well-formed execution state $\E$, for every store $\Theta$
that is causally consistent under $\E$, and for every contract class
$\tau \in \{{\sf ec},{\sf cc},{\sf sc}\}$, if:
\begin{smathpar}
  (\E, \Theta, \langle s,i,op_\tau ::
  \sigma \rangle \pll \Sigma) \xrightarrow{\eff} (\E', \Theta',
  \langle s,i+1,\sigma \rangle \pll \Sigma)
\end{smathpar}
then (\romannumeral 1) $\E'$ is well-formed, and (\romannumeral 2)
$\E' \models \cv_{\tau}[\eff/\cureff]$
\end{theorem}
\begin{proof}
  By case analysis on the derivation:
  \begin{smathpar}
    (\E, \Theta, \langle s,i,op_\tau ::
    \sigma \rangle \pll \Sigma) \xrightarrow{\eff} (\E', \Theta',
    \langle s,i+1,\sigma \rangle \pll \Sigma)
  \end{smathpar}
  Cases:
  \begin{itemize}
    \item Case \rulelabel{EC}: Hypotheses:
      \begin{smathpar}
      \begin{array}{cr}
      \tau = {\sf EventuallyConsistent} & H\npp \\
      \auxred{\Theta}{(\E,\langle s,i,op \rangle)} {r} 
        {(\E',\eff)} & H\npp\\
      \end{array}
      \end{smathpar}
      Goal (\romannumeral 1) follows from $H1$ and
      lemma~\ref{lem:auxred-wf}. Goal (\romannumeral 2) is the
      following: 
      \begin{smathpar}
      \begin{array}{cr}
        \E' \models \forall a,b. ~\hbo{a}{b} \wedge \vis{b}{\eff}
          \Rightarrow \vis{a}{\eff} & G\mpp\\
      \end{array}
      \end{smathpar}
      Let $\EffSoup' = \E'.\EffSoup$, $\Rvis' = \E'.\Rvis$, $\Rso' =
      \E'.\Rso$, and $\hboZ' =(\Rso' \cup \Rvis')^{+}$.  By inversion
      on $H1$, we get the following hypotheses:
      \begin{smathpar}
      \begin{array}{cr}
        \EffSoup' = \EffSoup \cup \{\eff\} & H\npp\\
        \visZ' = \Theta(r)\times\eff ~\cup~ \visZ & H\npp\\
        \Rso' = \EffSoup_{{\sf SessID}=s,\,{\sf SeqNo}<i}\times\eff ~\cup~ \Rso & H\npp\\
        \sameobjZ' = \EffSoup' \times \EffSoup'& H\npp\\
      \end{array}
      \end{smathpar}
       Since $\E'$ defines $\EffSoup'$ as the universe of values.
       Therefore, the goal can be rewritten:
      \begin{smathpar}
      \begin{array}{cr}
        \forall (a,b\in\EffSoup').
        \msentails{E'}{\De{\hbo{a}{b} \wedge
        \vis{b}{\eff}} \Rightarrow 
          \De{\vis{a}{\eff}}} & G\mpp\\
      \end{array}
      \end{smathpar}
      New hypotheses after \emph{intros}:
      \begin{smathpar}
      \begin{array}{cr}
        a \in \EffSoup' & H\npp\\
        b \in \EffSoup' & H\npp\\
      \end{array}
      \end{smathpar}
      And new goal:
      \begin{smathpar}
      \begin{array}{cr}
        \msentails{E'}{\De{\hbo{a}{b} \wedge
        \vis{b}{\eff}} \Rightarrow 
          \De{\vis{a}{\eff}}} & G\mpp\\
      \end{array}
      \end{smathpar}
      Since $(\mathcal{M} \models A \Rightarrow B) \Leftrightarrow
      (\mathcal{M} \models A \Rightarrow \mathcal{M} \models B)$, we
      prove $G0$ by proving: 
      \begin{smathpar}
      \begin{array}{cr}
        (\E' \models ~\hbo{a}{b} \wedge \vis{b}{\eff})
          \Rightarrow (\E' \models \vis{a}{\eff}) & G\mpp\\
      \end{array}
      \end{smathpar}
      After intros:
      \begin{smathpar}
      \begin{array}{cr}
        \E' \models ~\hbo{a}{b} \wedge \vis{b}{\eff} &
        H\npp\\
      \end{array}
      \end{smathpar}
      Since $\E'$ defines $\hboZ'$ and $\Rvis'$ as interpretations for
      $\hboZ$ and $\Rvis$ respectively, we have:
      \begin{smathpar}
      \begin{array}{cr}
          {{\sf hbo'}(a,b)} \wedge \Rvis'(b,\eff) & H\npp\\
      \end{array}
      \end{smathpar}
      And the goal is:
      \begin{smathpar}
      \begin{array}{cr}
        \Rvis'(a,\eff) & G\mpp\\
      \end{array}
      \end{smathpar}
      Inversion on $H9$:
      \begin{smathpar}
      \begin{array}{cr}
          {{\sf hbo'}(a,b)} & H\npp\\
          \Rvis'(b,\eff) & H\npp\\
      \end{array}
      \end{smathpar}
      Since $\eff$ is unique, from $H3$ and $H11$ we have the following:
      \begin{smathpar}
      \begin{array}{cr}
            b\in\Theta(r)& H\npp\\
      \end{array}
      \end{smathpar}
      Since $a,b \neq \eff$, we have that $\hboZ'(a,b) \Rightarrow
      \hboZ(a,b)$.  Since $\Theta(r)$ is causally consistent under
      $\E$, using $H10$ and $H12$ we derive the following:
      \begin{smathpar}
      \begin{array}{cr}
        a \in \Theta(r) & H\npp\\
      \end{array}
      \end{smathpar}
      Now, from $H3$ and $H13$, we deduce:
      \begin{smathpar}
      \begin{array}{cr}
        (a,\eff) \in \Rvis'& \\
      \end{array}
      \end{smathpar}
      which is what needs to be proven ($G4$).

    \item Case $\rulelabel{CC}$: Hypotheses:
      \begin{smathpar}
      \begin{array}{cr}
        \tau = {\sf CausallyConsistent} & H\npp \\
        \auxred{\Theta}{(\E,\langle s,i,op \rangle)} {r} 
          {(\E',\eff)} & H\npp\\
         \E'.\Rso(\eff) \subseteq \Theta(r)& H\npp\\
      \end{array}
      \end{smathpar}
     Goal (\romannumeral 1) follows from $H15$ and
     Lemma~\ref{lem:auxred-wf}. We now prove Goal (\romannumeral 2).
     Expanding the definition of $\ccc$, goal is the following:
      \begin{smathpar}
      \begin{array}{cr}
        \ccc = \forall a.~\hbo{a}{\eff} \Rightarrow
        \vis{a}{\eff} & G\mpp\\
      \end{array}
      \end{smathpar}
      Let $\EffSoup' = \E'.\EffSoup$, $\Rvis' = \E'.\Rvis$, $\Rso' =
      \E'.\Rso$, and $\hboZ' =(\Rso' \cup \Rvis')^{+}$. By inversion
      on $H15$, we get the following:
      \begin{smathpar}
      \begin{array}{cr}
        \EffSoup' = \EffSoup \cup \{\eff\} & H\npp\\
        \visZ' = \Theta(r)\times\eff ~\cup~ \visZ & H\npp\\
        \Rso' = \EffSoup_{{\sf SessID}=s,\,{\sf SeqNo}<i}\times\eff ~\cup~ \Rso & H\npp\\
        \sameobjZ' = \EffSoup' \times \EffSoup'& H\npp\\
      \end{array}
      \end{smathpar}
%     From $H16$ and $H19$, we have:
%     \begin{smathpar}
%     \begin{array}{cr}
%       \EffSoup_{{\sf SessID}=s,\,{\sf SeqNo}<i} \in \Theta(r) &
%       H\npp \\
%     \end{array}
%     \end{smathpar}
      By similar reasoning as with the previous case (\rulelabel{EC}),
      we get a context with following hypotheses:
      \begin{smathpar}
      \begin{array}{cr}
        a \in \EffSoup' & H\npp\\
        {\hboZ'(a,\eff)}  & H\npp\\
      \end{array}
      \end{smathpar}
      And the goal is the following:
      \begin{smathpar}
      \begin{array}{cr}
        \Rvis'(a,\eff) & G\mpp\\
      \end{array}
      \end{smathpar}
      Since \emph{happens-before} is transitive, by inversion on
      $H23$, we get two cases:
      \begin{itemize}
        \item SCase 1: Hypotheses:
        \begin{smathpar}
        \begin{array}{cr}
          (\Rso' \cup \Rvis')(a,\eff) & H\npp\\
        \end{array}
        \end{smathpar}
        Inversion on $H24$ leads to two subcases. In one case, we
        assume $\Rvis'(a,\eff)$ and try to prove the goal $G6$. The
        proof for this case mimics the proof for Case \rulelabel{EC}.
        Alternatively, in second case, we assume:
        \begin{smathpar}
        \begin{array}{cr}
          \Rso'(a,\eff) & H\npp\\
        \end{array}
        \end{smathpar}
        and prove $G6$. From $H25$ and $H16$, we infer:
        \begin{smathpar}
        \begin{array}{cr}
          a \in \Theta(r) & H\npp\\
        \end{array}
        \end{smathpar}
        Now, from $H26$ and $H18$ we know:
        \begin{smathpar}
        \begin{array}{cr}
          (a,\eff) \in \Rvis' & \\
        \end{array}
        \end{smathpar}
        which is the goal ($G6$).

        \item SCase 2: Hypotheses (after abbreviating the occurance
        of$(\Rso' \cup \Rvis')^{+}$ as {\sf hbo'}):
        \begin{smathpar}
        \begin{array}{cr}
          \exists(c\in\EffSoup').{\sf hbo'}(a,c) \wedge (\Rso' \cup
          \Rvis')(c,\eff) & H\npp\\
        \end{array}
        \end{smathpar}
        Inverting $H27$, followed by expanding $\Rso' \cup \Rvis'$:
        \begin{smathpar}
        \begin{array}{cr}
          c\in\EffSoup' & H\npp\\
           {\sf hbo'}(a,c) \wedge (\Rso'(c,\eff) \vee \Rvis'(c,\eff))& H\npp\\
        \end{array}
        \end{smathpar}
        Inverting the disjunction in $H29$, we get two cases:
        \begin{itemize}
          \item SSCase R: Hypothesis is
          \begin{smathpar}
          \begin{array}{cr}
             {\sf hbo'}(a,c) \wedge \Rvis'(c,\eff)& H\npp\\
          \end{array}
          \end{smathpar}
          Observe that hypothesis $H30$ and current goal ($G6$) are
          same as hypothesis $H9$ and goal ($G4$) in Case
          \rulelabel{EC}. The proof for this SSCase is also the same.

          \item SSCase L: Hypothesis is
          \begin{smathpar}
          \begin{array}{cr}
             {\sf hbo'}(a,c) \wedge \Rso'(c,\eff)& H\npp\\
          \end{array}
          \end{smathpar}
          Inverting $H31$:
          \begin{smathpar}
          \begin{array}{cr}
             {\sf hbo'}(a,c)& H\npp\\
             \Rso'(c,\eff)& H\npp\\
          \end{array}
          \end{smathpar}
          From $H33$ and $H16$, we infer:
          \begin{smathpar}
          \begin{array}{cr}
            c \in \Theta(r) & H\npp \\
          \end{array}
          \end{smathpar}
          Since $a,c \neq \eff$, we know that $\hboZ'(a,c) \Rightarrow
          \hboZ(a,c)$.  Since $\Theta(r)$ is causally consistent under
          $\E$, using $H32$ and $H34$ we derive the following:
          \begin{smathpar}
          \begin{array}{cr}
            a \in \Theta(r) & H\npp\\
          \end{array}
          \end{smathpar}
           Proof follows from $H35$ and $H18$.
        % End of SSCase
        \end{itemize}
      % End of SCases
      \end{itemize}

    \item Case \rulelabel{SC}: Hypotheses:
      \begin{smathpar}
      \begin{array}{cr}
        \tau = {\sf StronglyConsistent} & H\npp \\
        \auxred{\Theta} {(\E,\langle s,i,op \rangle)} {r}
        {(\E',\eff)} & H\npp\\ 
        \E.A \subseteq \Theta(r) & H\npp\\
        \dom(\Theta') = \dom(\Theta) & H\npp\\
        \forall r'\in \dom(\Theta'). \Theta'(r') = \Theta(r') \cup
          \{\eff\} & H\npp\\
      \end{array}
      \end{smathpar}
      Let $\EffSoup' = \E'.\EffSoup$, $\Rvis' = \E'.\Rvis$, $\Rso' =
      \E'.\Rso$, and $\hboZ' =(\Rso' \cup \Rvis')^{+}$. Inversion on
      $H37$ gives: 
      \begin{smathpar}
      \begin{array}{cr}
        \EffSoup' = \EffSoup \cup \{\eff\} & H\npp\\
        \visZ' = \Theta(r)\times\eff ~\cup~ \visZ & H\npp\\
        \Rso' = \EffSoup_{{\sf SessID}=s,\,{\sf SeqNo}<i}\times\eff ~\cup~ \Rso & H\npp\\
        \sameobjZ' = \EffSoup' \times \EffSoup'& H\npp\\
      \end{array}
      \end{smathpar}
       Goal (\romannumeral 1) follows from $H36$ and
       Lemma~\ref{lem:auxred-wf}. Expanding the definition of $\scc$,
       goal is the following:
      \begin{smathpar}
      \begin{array}{cr}
        \forall a.~\sameobj{a}{\eff} \Rightarrow \vis{a}{\eff} 
          ~\vee~ \vis{\eff}{a} ~\vee~ a = \eff & G\mpp\\
      \end{array}
      \end{smathpar}
      By similar reasoning as with the \rulelabel{EC} case,
      we get a context with following hypotheses:
      \begin{smathpar}
      \begin{array}{cr}
        a \in \EffSoup' & H\npp\\
        {\sameobjZ'(a,\eff)}  & H\npp\\
      \end{array}
      \end{smathpar}
      And the goal is the following:
      \begin{smathpar}
      \begin{array}{cr}
        \vis{a}{\eff} ~\vee~ \vis{\eff}{a} ~\vee~ a = \eff & G\mpp\\
      \end{array}
      \end{smathpar}
      From $H40$ and $H44$, we know that either $a \in \EffSoup$ or $a
      = \eff$. If $a = \eff$, then $G8$ follows trivially. On the
      other hand, when $a \in \EffSoup$, from $H37$ we know that $a
      \in \Theta(r)$. From $H41$, we derive:
      \begin{smathpar}
      \begin{array}{cr}
        a \in \visZ'(\eff)& \\
      \end{array}
      \end{smathpar}
      Which means first disjunct of $G8$ is valid, proving the
      theorem.
  % End of all cases    
  \end{itemize}
\end{proof}

\begin{corollary}[Soundness]
  \label{thm:soundness}
  For every well-formed execution state $\E$, for every store $\Theta$
  that is causally consistent under $\E$, for every contract class $\tau
  \in \{{\sf ec},{\sf cc},{\sf sc}\}$, and for every consistency
  contract $\cv$ in the contract class $\tau$, If:
  \begin{smathpar}
  (\E, \Theta, \langle s,i,op_\tau :: 
  \sigma \rangle \pll \Sigma) \xrightarrow{\eff} (\E', \Theta',
  \langle s,i+1,\sigma \rangle \pll \Sigma)
  \end{smathpar}
  then (\romannumeral 1) $\E'$ is well-formed, and (\romannumeral 2)
  $\E' \models \cv[\eff/\cureff]$
\end{corollary}
\begin{proof}
  Follows from Theorems~\ref{thm:classification-sound} and
  \ref{thm:weak-soundness}
  \qed
\end{proof}

We now show that every configuration of the store that is reachable
via the reduction relation ($\xrightarrow{}$) is causally consistent.

\begin{lemma}[Causal Consistency Preservation]
  \label{lem:local-state-is-cc}
  For every well-formed execution state $\E$, and a store $\Theta$
  that is causally consistent under $\E$, if: 
  \begin{smathpar}
    (\E, \Theta, \langle s,i,op_\tau ::
    \sigma \rangle \pll \Sigma) \xrightarrow{\eff} (\E', \Theta',
    \langle s,i+1,\sigma \rangle \pll \Sigma)
  \end{smathpar}
  then $\Theta'$ is causally consistent under $\E'$.
\end{lemma}
\begin{proof}
  By case analysis on on:
  \begin{smathpar}
    (\E, \Theta, \langle s,i,op_\tau ::
    \sigma \rangle \pll \Sigma) \xrightarrow{\eff} (\E', \Theta',
    \langle s,i+1,\sigma \rangle \pll \Sigma)
  \end{smathpar}
  Cases:
  \begin{itemize}
    \item Case \rulelabel{EffVis}: Final execution state is same as
    the initial (i.e., $\E' = \E$). Therefore, we need to prove that
    new store configuration $\Theta$ is causally consistent under
    $\E=\Exec$. Hypotheses:
    \begin{smathpar}
    \begin{array}{cr}
      r \in {\sf ReplID} & H\npp \\
      \eff \in A & H\npp \\
      \eff \notin \Theta(r)& H\npp \\
      \E.\visZ^{-1}(\eff) \cup \E.\soZ^{-1}(\eff) \subseteq \Theta(r)
      & H\npp \\
      \Theta' = \Theta \cup [r \mapsto \{\eff\} \cup \Theta(r)] & H\npp \\
      \hspace*{-0.5in}\forall (r\in{\sf dom}(\Theta)). \forall (\eff \in
        \Theta(r)). & \\
      \hspace*{0.3in}\forall (a\in\EffSoup). \hbo{a}{\eff} \Rightarrow a \in \Theta(r) & H\npp \\
    \end{array}
    \end{smathpar}
    From $H4$ and $H5$, it suffices to prove:
    \begin{smathpar}
    \begin{array}{cr}
      \forall (a\in \EffSoup). \hbo{a}{\eff} 
        \Rightarrow a \in \Theta'(r) & G\mpp\\
    \end{array}
    \end{smathpar}
    After \emph{intros}, hypotheses:
    \begin{smathpar}
    \begin{array}{cr}
      a\in\EffSoup & H\npp\\
      \hbo{a}{\eff} & H\npp \\
    \end{array}
    \end{smathpar}
    Goal:
    \begin{smathpar}
    \begin{array}{cr}
      a \in \Theta'(r) & G\mpp \\
    \end{array}
    \end{smathpar}
    Inversion on $H7$ leads to two cases:
    \begin{itemize}
      \item SCase \emph{$a$ directly precedes $\eff$ }: Hypothesis:
      \begin{smathpar}
      \begin{array}{cr}
        (\Rvis \cup \Rso)(a,\eff) & H\npp\\
      \end{array}
      \end{smathpar}
      From $H3$ and $H8$, we conclude that $a \in \Theta'(r)$.
      
      \item SCase \emph{$a$ transitively precedes $\eff$}: Hypothesis:
      \begin{smathpar}
      \begin{array}{cr}
        \exists (c \in \EffSoup). \hbo{a}{c} \wedge (\Rvis \cup
        \Rso)(c,\eff) & H\npp \\
      \end{array}
      \end{smathpar}
      Inverting $H9$:
      \begin{smathpar}
      \begin{array}{cr}
        c \in A & H\npp \\
        \hbo{a}{c} & H\npp \\
        (\Rvis \cup \Rso)(c,\eff) & H\npp \\
      \end{array}
      \end{smathpar}
      From $H3$ and $H12$, we have:
      \begin{smathpar}
      \begin{array}{cr}
        c \in \Theta'(r) & H\npp\\
      \end{array}
      \end{smathpar}
      From $H5$, $H13$ and $H11$, we conclude that $a \in \Theta'(r)$.
    \end{itemize}

    \item Cases \rulelabel{EC} and \rulelabel{CC}: Store configuration
    ($\Theta$) remains unchanged. Proof trivial.

    \item Case \rulelabel{SC}: $\Sigma = \tuplee{s,\sigma} \pll
    \Sigma_1$. Hypotheses:
    \begin{smathpar}
    \begin{array}{cr}
      r \in {\sf ReplID} & H\npp \\
      {\sf Unavailable}(\cv) & H\npp \\
      \E_1;\Theta_1;\tuplee{s,op(v); \sigma} 
        \;\xhookrightarrow{\eff,r}\; 
      \E;\Theta_2;\tuplee{s,\sigma} & H\npp\\
      \E_1.A \subseteq \Theta_1(r) & H\npp\\
      \dom(\Theta) = \dom(\Theta_2) & H\npp\\
      \forall r'\in \dom(\Theta). \Theta(r') = \Theta_2(r') \cup
      \{\eff\} & H\npp\\
    \end{array}
    \end{smathpar}
    Inductive hypothesis:
    \begin{smathpar}
    \begin{array}{cr}
      \hspace*{-0.5in}\forall (r'\in{\sf dom}(\Theta_1)). \forall (\eff' \in
        \Theta_1(r')). & \\
      \hspace*{0.3in}\forall (a\in\E_1.A). \hbo{a}{\eff'} \Rightarrow a
        \in \Theta_1(r') & IH\npp \\
    \end{array}
    \end{smathpar}
    The goal:
    \begin{smathpar}
    \begin{array}{cr}
      \hspace*{-0.5in}\forall (r'\in{\sf dom}(\Theta)). \forall (\eff' \in
        \Theta(r')). & \\
      \hspace*{0.3in}\forall (a\in\E.A). \hbo{a}{\eff'} \Rightarrow a
        \in \Theta(r') & G\mpp \\
    \end{array}
    \end{smathpar}
    Inverting $H16$:
    \begin{smathpar}
    \begin{array}{cr}
        \E.\EffSoup = \E_1.\EffSoup \cup \{\eff\} & H\npp\\
        \E.\visZ = \Theta_1(r)\times \{\eff\} ~\cup~ \E_1.\visZ & H\npp\\
        \E.\Rso = \E_1.\EffSoup_{{\sf SessID}=s,\,{\sf SeqNo}<i}\times
          \{\eff\} ~\cup~ \E_1.\Rso & H\npp\\
        \Theta_2 = \Theta_1 & H\npp\\
    \end{array}
    \end{smathpar}
    Using $H24$ to rewrite $H19$:
    \begin{smathpar}
    \begin{array}{cr}
      \forall r'\in \dom(\Theta). \Theta(r') = \Theta_1(r') \cup
      \{\eff\} & H\npp\\
    \end{array}
    \end{smathpar}
    Using $H25$ and $IH20$, we can reduce the goal ($G2$) to:
    \begin{smathpar}
    \begin{array}{cr}
      \forall (r'\in{\sf dom}(\Theta)). 
      \forall (a\in\E.\EffSoup). \hbo{a}{\eff} \Rightarrow a
        \in \Theta(r') & G\mpp \\
    \end{array}
    \end{smathpar}
    After \emph{intros}, hypotheses:
    \begin{smathpar}
    \begin{array}{cr}
      r' \in \dom(\Theta) & H\npp \\
      a \in \E.\EffSoup & H\npp\\
      \hbo{a}{\eff} & H\npp\\
    \end{array}
    \end{smathpar}
    Goal:
    \begin{smathpar}
    \begin{array}{cr}
      a \in \Theta(r) & G\mpp \\
    \end{array}
    \end{smathpar}
    From $H27$ and $H21$, we know that either $a \in \E_1.\EffSoup$ or
    $a = \eff$.
    \begin{itemize}
      \item If $a \in \E_1.\EffSoup$, then from $H17$, we know that $a
      \in \Theta_1(r)$. However, from $H25$ we know that $\Theta_1(r)
      \subset \Theta(r)$, which lets us conclude that $a \in
      \Theta(r)$.

      \item If $a = \eta$, then $H28$ is $\hbo{\eff}{\eff}$, which is
      $false$ since {\sf hbo} is irreflexive.
      \emph{ex\_falso\_quodlibet}.
    \end{itemize}
  % End of main cases  
  \end{itemize}
\qed
\end{proof}


